<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultra Games - UBG ULTRA</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            font-family: 'Inter', sans-serif;
            color: #222;
            overflow-x: hidden;
        }

        body {
            background: radial-gradient(ellipse at 20% 50%, rgba(138, 43, 226, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 80% 80%, rgba(30, 144, 255, 0.15) 0%, transparent 50%),
                        #0a0e27;
        }

        /* Animated stars */
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes drift {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(-20px) translateX(10px); }
        }

        .space-stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .star {
            position: absolute;
            background: #fff;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        .star.small { width: 1px; height: 1px; }
        .star.medium { width: 2px; height: 2px; }
        .star.large { width: 3px; height: 3px; }

        .nebula {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: drift 20s infinite ease-in-out;
        }

        .nebula.purple {
            width: 300px;
            height: 300px;
            background: rgba(138, 43, 226, 0.4);
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .nebula.blue {
            width: 250px;
            height: 250px;
            background: rgba(30, 144, 255, 0.4);
            top: 50%;
            right: 10%;
            animation-delay: 2s;
        }

        .nebula.cyan {
            width: 280px;
            height: 280px;
            background: rgba(0, 255, 255, 0.3);
            bottom: 10%;
            left: 20%;
            animation-delay: 4s;
        }
        
        .header {
            position: relative;
            z-index: 10;
            padding: 30px 20px;
            background: rgba(20, 25, 45, 0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(127, 90, 240, 0.2);
            box-shadow: 0 8px 32px rgba(127, 90, 240, 0.2);
        }
        
        .header h1 {
            margin: 0 0 20px 0;
            font-size: 2.2em;
            font-weight: 800;
            background: linear-gradient(120deg, #7f5af0 0%, #36cce4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            max-width: 600px;
            margin: 0 auto;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .search-bar {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 1.5px solid rgba(127, 90, 240, 0.3);
            border-radius: 25px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s;
        }

        .search-bar::placeholder {
            color: #707080;
        }
        
        .search-bar:focus {
            outline: none;
            border-color: #7f5af0;
            box-shadow: 0 0 0 3px rgba(127, 90, 240, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .clear-search {
            background: rgba(127, 90, 240, 0.3);
            color: #a0b0c0;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .clear-search.visible {
            display: flex;
        }

        .clear-search:hover {
            background: rgba(127, 90, 240, 0.5);
            color: #fff;
        }
        
        .content {
            position: relative;
            z-index: 5;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .section {
            margin-bottom: 50px;
        }
        
        .section-title {
            text-align: left;
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(120deg, #7f5af0 0%, #36cce4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(127, 90, 240, 0.3);
        }
        
        .game-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            margin-left: 0;
        }
        
        .card {
            background: rgba(20, 25, 45, 0.7);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(127, 90, 240, 0.2);
        }
        
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(127, 90, 240, 0.3);
            border-color: #7f5af0;
        }
        
        .card-icon {
            background: linear-gradient(135deg, #7f5af0 0%, #36cce4 100%);
            color: white;
            font-size: 40px;
            padding: 30px;
            text-align: center;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-cover {
            width: 100%;
            min-height: 120px;
            object-fit: cover;
            display: block;
            background: linear-gradient(135deg, #7f5af0 0%, #36cce4 100%);
        }
        
        .card-name {
            padding: 15px;
            font-weight: 600;
            color: #a0b0c0;
            text-align: center;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
            font-size: 13px;
        }
        
        #loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #7f5af0;
            font-size: 18px;
            font-weight: 600;
            z-index: 100;
        }

        #loading.visible {
            display: block;
        }
        
        /* Game Viewer Modal */
        #gameViewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            flex-direction: column;
        }

        #gameViewer.visible {
            display: flex;
        }
        
        .viewer-header {
            background: rgba(20, 25, 45, 0.95);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid rgba(127, 90, 240, 0.2);
        }
        
        .viewer-title {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
        }
        
        .viewer-controls button {
            background: rgba(127, 90, 240, 0.7);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .viewer-controls button:hover {
            background: #7f5af0;
            transform: translateY(-1px);
        }
        
        .viewer-controls button.close {
            background: #dc3545;
        }
        
        .viewer-controls button.close:hover {
            background: #c82333;
        }

        #gameFrame {
            flex: 1;
            border: none;
            width: 100%;
        }

        footer {
            position: relative;
            z-index: 5;
            background: rgba(20, 25, 45, 0.85);
            border-top: 1px solid rgba(127, 90, 240, 0.2);
            padding: 20px;
            text-align: center;
            color: #a0b0c0;
            font-size: 12px;
        }

        footer a {
            color: #7f5af0;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .offline-section {
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        #offlineBtn {
            background: rgba(127, 90, 240, 0.3);
            color: #a0b0c0;
            border: 1.5px solid rgba(127, 90, 240, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        #offlineBtn:hover:not(:disabled) {
            background: rgba(127, 90, 240, 0.5);
            border-color: #7f5af0;
            color: #fff;
        }

        #offlineBtn:disabled {
            opacity: 0.5;
            cursor: default;
        }

        .offline-progress-wrap {
            width: 100%;
            max-width: 500px;
            background: rgba(127, 90, 240, 0.15);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            display: none;
        }

        .offline-progress-wrap.visible {
            display: block;
        }

        #offlineProgress {
            height: 100%;
            background: linear-gradient(120deg, #7f5af0 0%, #36cce4 100%);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s;
        }

        #offlineStatus {
            color: #a0b0c0;
            font-size: 12px;
        }

        #offlineCancelBtn {
            background: rgba(255, 255, 255, 0.1);
            color: #a0b0c0;
            border: 1px solid rgba(127, 90, 240, 0.2);
            padding: 6px 14px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            display: none;
            transition: all 0.2s;
        }

        #offlineCancelBtn:hover {
            background: rgba(127, 90, 240, 0.2);
            color: #fff;
        }

        .viewer-controls button.fullscreen-btn {
            background: rgba(76, 175, 80, 0.7);
        }

        .viewer-controls button.fullscreen-btn:hover {
            background: #4caf50;
        }

        .viewer-controls button.fav-btn {
            background: rgba(233, 30, 99, 0.7);
        }

        .viewer-controls button.fav-btn:hover {
            background: #e91e63;
        }

        #clearCacheLink {
            color: #a0b0c0;
            font-size: 11px;
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        #clearCacheLink:hover {
            color: #7f5af0;
        }

        .info-banner {
            position: relative;
            z-index: 10;
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            padding: 12px 40px 12px 16px;
            font-size: 13px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 193, 7, 0.3);
        }

        .info-banner .dismiss-banner {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #ffc107;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 8px;
            line-height: 1;
            transition: color 0.2s;
        }

        .info-banner .dismiss-banner:hover {
            color: #ff9800;
        }

        @media (max-width: 540px) {
            .header h1 { font-size: 1.8em; }
            .search-bar { min-width: 200px; }
            .game-container { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        }
    </style>
</head>
<body>
    <!-- ANIMATED SPACE BACKGROUND -->
    <div class="space-stars">
        <div class="nebula purple"></div>
        <div class="nebula blue"></div>
        <div class="nebula cyan"></div>
    </div>

    <div class="info-banner" id="infoBanner">
        ‚ö†Ô∏è If a game shows a blank screen, wait a few seconds for it to load. If it still doesn't work, click <strong>"üìë New Tab"</strong> to open it directly.
        <button class="dismiss-banner" onclick="document.getElementById('infoBanner').style.display='none'; localStorage.setItem('gn_banner_dismissed','1');">‚úï</button>
    </div>
    <script>if(localStorage.getItem('gn_banner_dismissed')==='1') document.getElementById('infoBanner').style.display='none';</script>
    
    <div class="header">
        <h1>üéÆ Ultra Games</h1>
        <div class="search-container">
            <input type="text" class="search-bar" id="searchInput" placeholder="Search games...">
            <button class="clear-search" id="clearBtn">‚úï</button>
        </div>
        <div class="offline-section">
            <button id="offlineBtn" onclick="handleOfflineAction()" style="display:none">üì• Download All for Offline</button>
            <button id="offlineCancelBtn" onclick="cancelOfflineDownload()">Cancel</button>
            <span id="offlineStatus"></span>
            <a href="#" id="clearCacheLink" onclick="clearOfflineCache(); return false;" style="display:none">clear cache</a>
        </div>
        <div class="offline-section">
            <div class="offline-progress-wrap" id="offlineProgressWrap">
                <div id="offlineProgress"></div>
            </div>
        </div>
    </div>

    <div id="loading">Loading games...</div>

    <div class="content">
        <div class="section">
            <div class="section-title">‚≠ê Recently Played</div>
            <div class="game-container" id="recentContainer"></div>
        </div>

        <div class="section">
            <div class="section-title">‚ù§Ô∏è Favorites</div>
            <div class="game-container" id="favContainer"></div>
        </div>

        <div class="section">
            <div class="section-title">üéÆ All Games</div>
            <div class="game-container" id="gamesContainer"></div>
        </div>
    </div>

    <!-- Game Viewer Modal -->
    <div id="gameViewer">
        <div class="viewer-header">
            <div class="viewer-title" id="gameName">Game</div>
            <div class="viewer-controls">
                <button class="fav-btn" id="favBtn" onclick="toggleViewerFav()">‚ô° Fav</button>
                <button onclick="openInNewTab()">üìë New Tab</button>
                <button class="fullscreen-btn" id="fsBtn" onclick="toggleFullscreen()">üî≤ Fullscreen</button>
                <button class="close" onclick="closeViewer()">‚úï Close</button>
            </div>
        </div>
        <iframe id="gameFrame" sandbox="allow-same-origin allow-scripts allow-forms allow-pointer-lock allow-popups allow-modals allow-top-navigation" allow="autoplay; fullscreen; accelerometer; gyroscope;"></iframe>
    </div>

    <footer>
        <p>üéÆ Ultra Games ‚Äî Access 500+ Games</p>
        <p style="margin-top:6px;font-size:11px;color:#999">These games are hosted by third-party partners and are not owned, operated, or endorsed by UBG ULTRA.</p>
        <p style="margin-top:8px"><a href="/" onclick="return true;">‚Üê Back to Home</a></p>
    </footer>

    <script>
        // Check authentication cookie on page load
        function checkAuth() {
            const cookies = document.cookie.split(';');
            const hasAuth = cookies.some(cookie => cookie.trim().startsWith('ubg_auth='));
            if (!hasAuth) {
                window.location.href = '/';
            }
        }

        // Check auth immediately
        checkAuth();

        let allGames = [];
        let currentGame = null;
        const MAX_RECENT = 5;
        const CACHE_NAME = 'gn-offline-v1';
        let offlineCancelled = false;
        const COVERS_CDN = 'https://cdn.jsdelivr.net/gh/gn-math/covers@main';
        let coverMap = {};

        const PROBLEMATIC_GAMES = new Set([
            "Amanda the Adventurer", "Andys Apple Farm", "Baldis Basics Classic Remastered",
            "Bendy and the Ink Machine", "Class of 09", "Cooking Mama 3", "Cuphead",
            "Deltatraveler", "Duck Life 8", "FIFA 10", "FIFA 11", "Fears to Fathom_ Home Alone",
            "Final Fantasy VII", "Five Nights at Epsteins", "Flappy Bird",
            "Getting Over It with Bennett Foddy", "Granny 2", "Granny 3", "Kindergarten",
            "Kindergarten 2", "Kindergarten 3", "Kirby  Soft  Wet", "Kirby Super Star Ultra",
            "Metal Gear Solid", "Milk Outside A Bag Of Milk Outside A Bag Of Milk",
            "Nubbys Number Factory", "Oshi Oshi Punch", "Pizza Tower", "Pokemon HeartGold",
            "Quake III Arena", "REPO", "Raft", "Raldis Crackhouse", "Real Flight Simulator",
            "Rolling Sky", "Side Effects", "Slender_ The 8 Pages", "Slope", "SpiderDoll",
            "Steal A Brainrot", "Swordfight", "The Legend of Zelda Majoras Mask",
            "The Legend of Zelda Ocarina of Time", "The Man In The Window", "They Are Coming",
            "Tomodachi Collection", "Touhou_ Luminous Strike", "Undertale Yellow", "Yandere Simulator"
        ]);

        // Generate stars dynamically
        function generateStars() {
            const container = document.querySelector('.space-stars');
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                const size = Math.random() > 0.5 ? 'small' : (Math.random() > 0.5 ? 'medium' : 'large');
                star.className = `star ${size}`;
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = (Math.random() * 3) + 's';
                container.appendChild(star);
            }
        }

        generateStars();

        // Initialize
        async function initGames() {
            try {
                document.getElementById('loading').classList.add('visible');
                const response = await fetch('/games/games.json');
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                
                const games = await response.json();
                allGames = games.filter(g => !g.id.startsWith('-') && !g.name.includes('[!]'));

                try {
                    const zr = await fetch('https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json');
                    if (zr.ok) {
                        const zones = await zr.json();
                        zones.forEach(z => { if (z.name && z.id) coverMap[z.name] = z.id; });
                    }
                } catch(e) { 
                    console.log('Cover map unavailable (non-critical)');
                }

                renderGames();
                renderRecent();
                renderFavorites();
                document.getElementById('loading').classList.remove('visible');
                updateOfflineButton();
            } catch (error) {
                console.error('Error loading games:', error);
                document.getElementById('loading').textContent = '‚ùå Failed to load games: ' + error.message;
                document.getElementById('loading').style.color = '#ff6b6b';
            }
        }

        function renderGames() {
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '';
            allGames.forEach(game => {
                container.appendChild(createCard(game));
            });
        }

        function renderRecent() {
            const recent = getRecent();
            const container = document.getElementById('recentContainer');
            container.innerHTML = '';
            
            if (recent.length === 0) {
                container.innerHTML = '<p style="color:#999">No games played yet</p>';
                return;
            }

            recent.forEach(gameId => {
                const game = allGames.find(g => g.id === gameId);
                if (game) container.appendChild(createCard(game));
            });
        }

        function renderFavorites() {
            const favs = getFavorites();
            const container = document.getElementById('favContainer');
            container.innerHTML = '';
            
            if (favs.length === 0) {
                container.innerHTML = '<p style="color:#999">No favorites yet</p>';
                return;
            }

            favs.forEach(gameId => {
                const game = allGames.find(g => g.id === gameId);
                if (game) container.appendChild(createCard(game));
            });
        }

        function createCard(game) {
            const card = document.createElement('div');
            card.className = 'card';

            const numId = coverMap[game.name] || (/^\d+$/.test(game.id) ? game.id : null);
            if (numId !== null) {
                card.innerHTML = `
                    <img class="card-cover" src="${COVERS_CDN}/${numId}.png" alt="" loading="lazy"
                         onerror="this.outerHTML='<div class=card-icon>üéØ</div>'">
                    <div class="card-name">${game.name}</div>
                `;
            } else {
                card.innerHTML = `
                    <div class="card-icon">üéØ</div>
                    <div class="card-name">${game.name}</div>
                `;
            }
            card.onclick = () => playGame(game);
            return card;
        }

        function getFavorites() {
            try {
                return JSON.parse(localStorage.getItem('gn_favorites') || '[]');
            } catch {
                return [];
            }
        }

        function addFavorite(gameId) {
            const favs = getFavorites();
            if (!favs.includes(gameId)) {
                favs.push(gameId);
                localStorage.setItem('gn_favorites', JSON.stringify(favs));
                renderFavorites();
            }
        }

        function removeFavorite(gameId) {
            let favs = getFavorites();
            favs = favs.filter(id => id !== gameId);
            localStorage.setItem('gn_favorites', JSON.stringify(favs));
            renderFavorites();
        }

        function getRecent() {
            try {
                return JSON.parse(localStorage.getItem('gn_lastPlayed') || '[]');
            } catch {
                return [];
            }
        }

        function addRecent(gameId) {
            let recent = getRecent();
            recent = recent.filter(id => id !== gameId);
            recent.unshift(gameId);
            recent = recent.slice(0, MAX_RECENT);
            localStorage.setItem('gn_lastPlayed', JSON.stringify(recent));
            renderRecent();
        }

        // Game Viewer
        async function playGame(game) {
            currentGame = game;
            
            if (PROBLEMATIC_GAMES.has(game.name)) {
                showWarningModal(game);
                return;
            }
            
            loadGameSafe(game);
        }
        
        function showWarningModal(game) {
            const warningHtml = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:2000;" id="warningOverlay" onclick="if(event.target.id==='warningOverlay') closeWarning()">
                    <div style="background:rgba(20, 25, 45, 0.95);padding:40px;border-radius:12px;max-width:400px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.3);border:1px solid rgba(127, 90, 240, 0.2);">
                        <div style="font-size:48px;margin-bottom:20px;">‚ö†Ô∏è</div>
                        <h2 style="margin:0 0 15px 0;color:#fff;font-size:22px;">${game.name}</h2>
                        <p style="margin:0 0 25px 0;color:#a0b0c0;font-size:15px;line-height:1.5;">This game has been reported by users to not work properly (black screen, loading issues, or crashes).</p>
                        <p style="margin:0 0 30px 0;color:#707080;font-size:13px;">You can still try playing it, but you may experience issues.</p>
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeWarning()" style="flex:1;padding:12px;background:rgba(127, 90, 240, 0.3);border:1px solid rgba(127, 90, 240, 0.5);border-radius:6px;cursor:pointer;font-weight:600;color:#a0b0c0;transition:all 0.2s;" onmouseover="this.style.background='rgba(127, 90, 240, 0.5)'" onmouseout="this.style.background='rgba(127, 90, 240, 0.3)'">‚Üê Go Back</button>
                            <button onclick="playAnyway('${game.id}')" style="flex:1;padding:12px;background:#dc3545;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.2s;" onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">Play Anyway</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', warningHtml);
        }
        
        function closeWarning() {
            const overlay = document.getElementById('warningOverlay');
            if (overlay) overlay.remove();
        }
        
        function playAnyway(gameId) {
            closeWarning();
            const game = allGames.find(g => g.id === gameId);
            if (game) loadGameSafe(game);
        }
        
        function loadGameSafe(game) {
            addRecent(game.id);
            
            const viewer = document.getElementById('gameViewer');
            const frame = document.getElementById('gameFrame');
            document.getElementById('gameName').textContent = game.name;
            
            const favBtn = document.getElementById('favBtn');
            if (favBtn) favBtn.textContent = getFavorites().includes(game.id) ? '‚ô• Fav' : '‚ô° Fav';
            
            viewer.classList.add('visible');
            
            window.location.hash = encodeURIComponent(game.name);
            
            const gameUrl = `/games/${encodeURIComponent(game.folder)}/`;
            frame.src = gameUrl;
        }

        function closeViewer() {
            if (document.fullscreenElement) document.exitFullscreen();
            document.getElementById('gameViewer').classList.remove('visible');
            document.getElementById('gameFrame').src = 'about:blank';
            const fsBtn = document.getElementById('fsBtn');
            if (fsBtn) fsBtn.textContent = 'üî≤ Fullscreen';
            history.replaceState(null, '', window.location.pathname + window.location.search);
        }

        function openInNewTab() {
            if (currentGame) {
                const url = `/games/${encodeURIComponent(currentGame.folder)}/`;
                window.open(url, '_blank');
            }
        }

        function toggleFullscreen() {
            const frame = document.getElementById('gameFrame');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                frame.requestFullscreen().catch(() => {
                    document.getElementById('gameViewer').requestFullscreen().catch(() => {});
                });
            }
        }

        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fsBtn');
            if (btn) btn.textContent = document.fullscreenElement ? '‚¨ú Exit FS' : 'üî≤ Fullscreen';
        });

        function toggleViewerFav() {
            if (!currentGame) return;
            const favs = getFavorites();
            const btn = document.getElementById('favBtn');
            if (favs.includes(currentGame.id)) {
                removeFavorite(currentGame.id);
                if (btn) btn.textContent = '‚ô° Fav';
            } else {
                addFavorite(currentGame.id);
                if (btn) btn.textContent = '‚ô• Fav';
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (document.fullscreenElement) return;
                const viewer = document.getElementById('gameViewer');
                if (viewer.classList.contains('visible')) {
                    closeViewer();
                }
            }
        });

        // Offline Download System
        async function getOfflineState() {
            if (!('caches' in window)) return { supported: false };
            try {
                const cache = await caches.open(CACHE_NAME);
                const paths = allGames.map(g => ({
                    path: `/games/${encodeURIComponent(g.folder)}/`,
                    id: g.id,
                    name: g.name,
                    folder: g.folder
                }));
                const results = await Promise.all(paths.map(async p => {
                    const match = await cache.match(p.path);
                    return { ...p, cached: !!match };
                }));
                const missing = results.filter(r => !r.cached);
                const downloaded = results.length - missing.length;
                return { supported: true, total: paths.length, downloaded, missing };
            } catch { return { supported: false }; }
        }

        async function updateOfflineButton() {
            const btn = document.getElementById('offlineBtn');
            const status = document.getElementById('offlineStatus');
            const clearLink = document.getElementById('clearCacheLink');
            if (!btn) return;
            const state = await getOfflineState();
            if (!state.supported || state.total === 0) { btn.style.display = 'none'; return; }
            btn.style.display = '';
            btn.disabled = false;
            if (state.downloaded === 0) {
                btn.textContent = `üì• Download All ${state.total} Games for Offline`;
                btn.dataset.action = 'download-all';
                status.textContent = '';
                if (clearLink) clearLink.style.display = 'none';
            } else if (state.missing.length > 0) {
                btn.textContent = `üì• Add ${state.missing.length} New Games`;
                btn.dataset.action = 'add-new';
                status.textContent = `${state.downloaded}/${state.total} cached`;
                if (clearLink) clearLink.style.display = 'none';
            } else {
                btn.textContent = 'üîç Check for Corruption';
                btn.dataset.action = 'check';
                status.textContent = `All ${state.total} games cached ‚úì`;
                if (clearLink) clearLink.style.display = '';
            }
        }

        async function handleOfflineAction() {
            const btn = document.getElementById('offlineBtn');
            if (btn.dataset.action === 'check') await checkCorruption();
            else await downloadGamesForOffline();
        }

        async function downloadGamesForOffline() {
            const btn = document.getElementById('offlineBtn');
            const progressWrap = document.getElementById('offlineProgressWrap');
            const progressBar = document.getElementById('offlineProgress');
            const status = document.getElementById('offlineStatus');
            const cancelBtn = document.getElementById('offlineCancelBtn');
            offlineCancelled = false;
            btn.disabled = true;
            cancelBtn.style.display = '';
            progressWrap.classList.add('visible');
            progressBar.style.width = '0%';

            const state = await getOfflineState();
            if (!state.supported) return;
            const toDownload = state.missing;
            const total = toDownload.length;

            const cache = await caches.open(CACHE_NAME);
            let done = 0, failed = 0;

            for (const entry of toDownload) {
                if (offlineCancelled) break;
                const url = `/games/${encodeURIComponent(entry.folder)}/`;
                const name = entry.name || entry.folder;
                try {
                    const resp = await fetch(url);
                    if (resp && resp.ok) {
                        const html = await resp.text();
                        await cache.put(url, new Response(html, { headers: { 'Content-Type': 'text/html' } }));
                        done++;
                    } else { failed++; }
                } catch (e) {
                    failed++;
                    if (e.name === 'QuotaExceededError') {
                        status.textContent = `Storage full after ${done} games`;
                        break;
                    }
                }
                btn.textContent = `üì• ${done}/${total} ‚Äî ${name}`;
                status.textContent = `Downloading: ${name}`;
                progressBar.style.width = `${(done / total) * 100}%`;
            }

            cancelBtn.style.display = 'none';
            progressBar.style.width = '100%';
            if (failed > 0) {
                status.textContent = `Done ‚Äî ${done} saved, ${failed} failed`;
            } else {
                status.textContent = `All ${done} games saved ‚úì`;
            }
            setTimeout(() => progressWrap.classList.remove('visible'), 3000);
            await updateOfflineButton();
        }

        function cancelOfflineDownload() {
            offlineCancelled = true;
            document.getElementById('offlineCancelBtn').style.display = 'none';
        }

        async function checkCorruption() {
            const btn = document.getElementById('offlineBtn');
            const progressWrap = document.getElementById('offlineProgressWrap');
            const progressBar = document.getElementById('offlineProgress');
            const status = document.getElementById('offlineStatus');
            btn.disabled = true;
            btn.textContent = 'üîç Checking‚Ä¶';
            progressWrap.classList.add('visible');
            progressBar.style.width = '0%';

            try {
                const cache = await caches.open(CACHE_NAME);
                const keys = await cache.keys();
                let ok = 0, bad = 0;
                for (let i = 0; i < keys.length; i++) {
                    try {
                        const resp = await cache.match(keys[i]);
                        const text = await resp.text();
                        if (text && text.length > 100 && text.includes('<')) { ok++; }
                        else { bad++; await cache.delete(keys[i]); }
                    } catch { bad++; await cache.delete(keys[i]); }
                    progressBar.style.width = `${((i + 1) / keys.length) * 100}%`;
                    status.textContent = `Checking ${i + 1}/${keys.length}‚Ä¶`;
                }
                progressBar.style.width = '100%';
                status.textContent = bad > 0
                    ? `Found ${bad} corrupt ‚Äî removed. Re-download to fix.`
                    : `All ${ok} games OK ‚úì`;
            } catch (e) {
                status.textContent = 'Check failed: ' + e.message;
            }
            setTimeout(() => progressWrap.classList.remove('visible'), 3000);
            await updateOfflineButton();
        }

        async function clearOfflineCache() {
            if (confirm('Remove all cached games? You can re-download them later.')) {
                await caches.delete(CACHE_NAME);
                await updateOfflineButton();
            }
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const container = document.getElementById('gamesContainer');
            container.innerHTML = '';
            
            document.getElementById('clearBtn').classList.toggle('visible', query.length > 0);
            
            if (!query) {
                renderGames();
                return;
            }
            
            const filtered = allGames.filter(g => g.name.toLowerCase().includes(query));
            filtered.forEach(game => {
                container.appendChild(createCard(game));
            });
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearBtn').classList.remove('visible');
            renderGames();
        });

        window.addEventListener('load', () => {
            initGames();
        });
    </script>
</body>
</html>
